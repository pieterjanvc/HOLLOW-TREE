# Deploying SCUIRREL and ACCORNS

This guide provides instructions on how to deploy the SCUIRREL and ACCORNS applications
on a server. It will cover all dependencies and necessary app configurations.

_For details on how the applications were built and how to run them locally, please read
the [developer guide](developer.md)_

## Shiny for Python

Both SCUIRREL and ACCORNS are built using the [Shiny](https://shiny.posit.co/py/)
library for Python. This means the apps were created and run in Python, but the
front-end is automatically built using HTML, CSS and JavaScript. The apps are designed
to be run in a web browser and can be accessed from any device with a web browser.

Python version 3.9 or higher is required to run the apps and the list of all Python
dependencies can be found in the [requirements.txt](requirements.txt) file.

## PostgreSQL

There are two PostgreSQL databases that store all data for the SCUIRREL and ACCORNS
applications and two users (accorns and scuirrel) that will access the DB from the apps.

- ACCORNS database (accorns): This relational database stores all the data that is used
  to run, monitor and manage the SCUIRREL apps (read-write).
- Vector database (vector_db): This database stores the vectors generated by the LLMs
  when course material are uploaded (writing). It is then used by SCUIRREL to guide the
  conversation and by ACCORNS to generate quiz questions (read-only).

_NOTE: Developers or people wanting to run the apps locally can use an SQLite database
(accorns) and DuckDB (vector_db) instead, omitting the need to setup a (local)
PostgreSQL instance. The schema for both PostgreSQL or file-based databases is
identical. For more information details, please refer to the
[developer guide](developer.md). Note that trying to deploy the apps using file based
databases will likely fail as the they need to be shared between the apps and handle
concurrent reading / writing._

### Setup

Both PostgreSQL databases are accessed by the scuirrel and accorns users. These users
are created automatically when running the script for the first time, but the passwords
need to be present as environment variables in order for this to work (not hard-coded).

- POSTGRES_PASS_SCUIRREL this environment variable should be set to the password for the
  scuirrel user
- POSTGRES_PASS_ACCORNS this environment variable should be set to the password for the
  accorns user

_NOTE: these environment variables should also be accessible in the environment where
the apps are run (details at the end)_

To create the databases:

- Host a PostgreSQL server (or use one like Amazon RDS, Google Cloud SQL, etc.)
- Install the [pgvector](https://github.com/pgvector/pgvector) extension (many cloud
  services have this pre-installed).
- On Windows, you can run the
  [appDB_postgres_init.bat](../ACCORNS/appDB/appDB_postgres_init.bat) file to create and
  setup the databases. Alternatively:
  - Run the [appDB_postgres_accorns.sql](../ACCORNS/appDB/appDB_postgres_accorns.sql)
    script to create the ACCORNS database / users (providing the passwords and other
    variables to the script)
  - Run the [appDB_postgres_vector.sql](../ACCORNS/appDB/appDB_postgres_vector.sql)
    script to create the vector database / users (providing the passwords and other
    variables to the script)

## Posit Connect / Shiny Server

[Posit](https://posit.co/), the creators of the open-source Shiny library for Python
(and R), also provide the software needed to host the apps online. There are two options
they provide:

- Shiny server (open source): This is a server that can host Shiny apps and is
  recommended for small deployments. It can be installed on a local server or on a cloud
  service like AWS, Google Cloud, etc.
- Posit Connect (paid): This is a cloud service that can host Shiny apps and is
  recommended for larger deployments. It is a paid service and likely requires
  institutional support.

Details on how to install and configure either option can be found on the
[Shiny server website](https://posit.co/products/open-source/shinyserver/)

## Deploying the apps to the server

The Git repository file structure is setup to build and test the apps locally. In order
to deploy the apps to a server, separate folders for each app (SCUIRREL and ACCORNS)
should be generated using the following steps:

1. Run the [generate_publishing_dir.py](publish/generate_publishing_dir.py) script with
   either ACCORNS or SCUIRREL argument

```
python generate_publishing_dir.py ACCORNS
python generate_publishing_dir.py SCUIRREL
```

This will generate or overwrite a SCUIRREL / ACCORNS folder in the publish directory

2. Make sure to check shared_config.toml file

   - remoteAppDB should be set to True to ensure PostgreSQL is used
   - The postgres host / port should be set to match your PostgreSQL server
   - Other settings in the shared_config.toml, accorns_config.toml and
     scuirrel_config.toml files should be set to match your preferred setup (details in
     the [developer guide](developer.md))

3. (OPTION 1) Publish the app with Posit Connect

Navigate to the publish/SCUIRREL or publish/ACCORNS folder and run the following
command:

```
rsconnect deploy shiny --server <server URL> --api-key <API key> ./
```

This will deploy the app to the specified server, and install all necessary
dependencies.

For more info visit https://docs.posit.co/connect/admin/

4. (OPTION 2) Deploy the app to a Shiny server.

This is done manually by copying the contents of the SCUIRREL or ACCORNS folder to the
correct location on the server. The server should be configured to run Python Shiny apps
and have the necessary dependencies installed.

For more info visit https://rstudio.github.io/shiny-server/os/latest/

5. Setup the necessary environment variables

The first deployment of the apps will fail as the environment variables are not set yet.
To fix this, log into the server and set the following environment variables:

- POSTGRES_PASS_SCUIRREL : The password for the scuirrel user
- POSTGRES_PASS_ACCORNS : The password for the accorns user
- OPENAI_API_KEY : The key for accessing the OpenAI API
- OPENAI_ORGANIZATION : The organization ID for accessing the OpenAI API (is this needed
  in case your default organization does not match the one used by the API key)

6. Reload your apps / restart the server to apply the changes
