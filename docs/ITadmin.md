# Deploying SCUIRREL and ACCORNS

This guide provides instructions on how to deploy the SCUIRREL and ACCORNS applications
on a server. It will cover all dependencies and necessary app configurations.

_For details on how the SCUIRREL and ACCORNS applications were built and how to run them
locally, please read the [developer guide](developer.md)_

## Shiny for Python

Both SCUIRREL and ACCORNS are built using the [Shiny](https://shiny.posit.co/py/)
library for Python. In short, Shiny apps are created and run in Python, with the
front-end (HTML, CSS and JavaScript) dynamically generated at runtime with Python
providing the backend server functionality. The apps are designed to be run in a web
browser and can be accessed from any device with access to the apps.

### Shiny Setup

- Python version 3.9 or higher (developed with 3.11)
- A list of all dependencies can be found in the [requirements.txt](../requirements.txt)
  file.

## PostgreSQL

Two PostgreSQL databases store all data for the SCUIRREL and ACCORNS applications and
two postgres user accounts (accorns and scuirrel) will need to be created to access the
DB from within the apps. The two databases are:

- ACCORNS database (accorns): This relational database stores all the data that is used
  to run, monitor and manage the SCUIRREL apps (read-write).
- Vector database (vector_db): This database stores the vectors generated by the LLMs
  when course material are uploaded (writing). It is then used for retrieval augmented
  generation (RAG) by SCUIRREL to guide the conversation (read-only) and by ACCORNS to
  generate quiz questions or add new files (read-write).

_NOTE: Developers or people wanting experiment with the apps locally can use an SQLite
database (accorns) and DuckDB (vector_db) instead, omitting the need to setup a
PostgreSQL instance. For more details, please refer to the
[developer guide](developer.md). Note that trying to deploy the apps using file based
databases will fail as the they need to be shared between the apps and handle concurrent
reading / writing._

### PostgreSQL Setup

See the [PostgreSQL setup guide](extra/postgres_setup.md) for more details on how to
setup the PostgreSQL databases on a remote server and connect them to the apps.

## Posit Connect / Shiny Server

[Posit](https://posit.co/), the creators of the open-source Shiny library for Python
(and R), also provide the software needed to host the apps online. There are two
available options:

- Shiny server (open source): This is a server that can host Shiny apps and is
  recommended for small deployments. It can be installed on a local server or on a cloud
  service like AWS, Google Cloud, etc.
- Posit Connect (paid): This is a cloud service that can host Shiny apps and is
  recommended for larger deployments. It is a paid service and likely requires
  institutional support.

Details on how to install and configure either option can be found on the
[Shiny server website](https://posit.co/products/open-source/shinyserver/)

## Generating production apps and deploying them

The Git repository file structure is setup to build and test the apps locally. For
production two separate app folders need to be generated and deployed individually to
the server. The production apps are generated using the following steps:

### 1. Run the [generate_publishing_dir.py](../publish/generate_publishing_dir.py) script

```bash
python publish/generate_publishing_dir.py
```

The following arguments can be set:

- --app <name> : App to generate (SCUIRREL or ACCORNS). If not set, both app folders are
  generated
- --localDB : If set, local, file based databases are used (not compatible with online deployment)
- --addDemo : Add the built-in demo to the app (accessible to all users by default)
- --personalInfo: If set, personal (identifiable) information (name and email) is
  required when setting up an account
- --sqliteDB <path> : Path to a local sqlite database. Defaults to what is set in
  [shared_config.toml](../shared/shared_config.toml) (ignored when `remoteAppDB` is
  True)
- --duckDB <path> : Path to a local duckdb database. Defaults to what is set in
  [shared_config.toml](../shared/shared_config.toml) (ignored when `remoteAppDB` is
  True)
- --pHost <host>: Postgres host address. Defaults to what is set in
  [shared_config.toml](../shared/shared_config.toml)
- --pPort <port>: Postgres port. Defaults to what is set in
  [shared_config.toml](../shared/shared_config.toml)
- --gptModel <modelName> : Default is GPT model to use defined in
  [shared_config.toml](../shared/shared_config.toml)
- --validEmail <regex> : Which email addresses can register. Defaults to what is set in
  [shared_config.toml](../shared/shared_config.toml)

_Running this script will overwrite existing SCUIRREL / ACCORNS folders in the publish
directory_

### 2. Check the configuration files in the publishing folders

- If all arguments were set correctly in the previous step, the
  `publish/ACCORNS/shared_config.toml` and `publish/SCUIRREL/shared_config.toml` should
  reflect these settings.
- Other settings in the `publish/ACCORNS/accorns_config.toml` and
  `publish/SCUIRREL/scuirrel_config.toml` files should can be set manually if needed
  (details in the [developer guide](developer.md))

### 3. Verify relevant environment variables

The following environment variables need to be set on the server:

- POSTGRES_PASS_SCUIRREL : The password for the scuirrel user
- POSTGRES_PASS_ACCORNS : The password for the accorns user
- OPENAI_API_KEY : The key for accessing the OpenAI API
- OPENAI_ORGANIZATION : The organization ID for accessing the OpenAI API (is this needed
  in case your default organization does not match the one used by the API key)

See the next step on how to set them up

### 3. (OPTION 1) Publish the app to Posit Connect

You will need

- The URL of a Posit Connect server
- An API key for the Posit Connect server with publish access
- Have rsconnect pip installed (see [requirements_dev.txt](../requirements_dev.txt))
- All relevant app environment variable values

The environment variables listed in step 2 need to be available when running the
`rsconnect` command below. Alternatively, you can add / edit environment variables
manually _after_ the apps are deployed by defining them through the the Posit connect
web interface in the app settings.

As SCUIRREL depends on ACCORNS, the **ACCORNS app should be published first**. To
upload, setup and deploy an app to the server run:

#### linux / MacOS

```sh
rsconnect deploy shiny \
  --server <server URL> \
  --api-key <API key> \
  --environment POSTGRES_PASS_SCUIRREL=$POSTGRES_PASS_SCUIRREL \
  --environment POSTGRES_PASS_ACCORNS=$POSTGRES_PASS_ACCORNS> \
  --environment OPENAI_API_KEY=$OPENAI_API_KEY \
  --environment OPENAI_ORGANIZATION=$OPENAI_ORGANIZATION \
  <path to publish/ACCORNS or publish/SCUIRREL>
```

#### Windows

```bat
rsconnect deploy shiny ^
  --server <server URL> ^
  --api-key <API key> ^
  --environment POSTGRES_PASS_SCUIRREL=%POSTGRES_PASS_SCUIRREL% ^
  --environment POSTGRES_PASS_ACCORNS=%POSTGRES_PASS_ACCORNS% ^
  --environment OPENAI_API_KEY=%OPENAI_API_KEY% ^
  --environment OPENAI_ORGANIZATION=%OPENAI_ORGANIZATION% ^
  <path to publish/ACCORNS or publish/SCUIRREL>
```

_If the environment variables are not available or incorrect the apps will be deployed
but the deployment test will fail_

NOTE: If you already deployed the app before, you can update it by adding the
`--app-id <GUID>` argument to the command above. You can find these IDs in the Posit
Connect dashboard in the app info section.

For more info visit https://docs.posit.co/connect/admin/

### 3. (OPTION 2) Deploy the app to a Shiny server.

This is done manually by copying the contents of the `publish/ACCORNS` or
`publish/SCUIRREL` folder to the correct location on the server. The server should be
configured to run Python Shiny apps and have the necessary dependencies installed listed
in [requirements.txt](../requirements.txt). Make sure all environment variables defined
in step 2 are present on the remote server before attempting to access the apps.

For more info visit https://rstudio.github.io/shiny-server/os/latest/

## Monitoring the apps

By accessing the accorns PostgreSQL database, you can monitor the usage of the SCUIRREL
and ACCORNS apps. The most useful table for this purpose is 'sessions' table, which logs
whenever someone starts / ends a session. The error column will also record any session
that ended because of an app crash, with a traceback of the error for debugging purposes
(though these should also be logged by PositConnect / Shiny Server). Details on the 
available data can be found in the [researcher guide](./researcher.md)
