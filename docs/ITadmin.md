# Deploying SCUIRREL and ACCORNS

This guide provides instructions on how to deploy the SCUIRREL and ACCORNS applications
on a server. It will cover all dependencies and necessary app configurations.

_For details on how the applications were built and how to run them locally, please read
the [developer guide](developer.md)_

## Shiny for Python

Both SCUIRREL and ACCORNS are built using the [Shiny](https://shiny.posit.co/py/)
library for Python. This means the apps were created and run in Python, but the
front-end is automatically built using HTML, CSS and JavaScript. The apps are designed
to be run in a web browser and can be accessed from any device with a web browser.

### Shiny Setup

- Python version 3.9 or higher (developed with 3.11)
- A list of all dependencies can be found in the [requirements.txt](../requirements.txt)
  file.

## PostgreSQL

Two PostgreSQL databases are needed to store all data for the SCUIRREL and ACCORNS
applications and two users (accorns and scuirrel) will access the DB from within the
apps.

- ACCORNS database (accorns): This relational database stores all the data that is used
  to run, monitor and manage the SCUIRREL apps (read-write).
- Vector database (vector_db): This database stores the vectors generated by the LLMs
  when course material are uploaded (writing). It is then used by SCUIRREL to guide the
  conversation and by ACCORNS to generate quiz questions (read-only).

_NOTE: Developers or people wanting to run the apps locally can use an SQLite database
(accorns) and DuckDB (vector_db) instead, omitting the need to setup a PostgreSQL
instance. For more details, please refer to the [developer guide](developer.md). Note
that trying to deploy the apps using file based databases will likely fail as the they
need to be shared between the apps and handle concurrent reading / writing._

### PostgreSQL Setup

See the [PostgreSQL setup guide](extra/postgres_setup.md) for more details on how to
setup the PostgreSQL databases on a remote server and connect them to the apps.

## Posit Connect / Shiny Server

[Posit](https://posit.co/), the creators of the open-source Shiny library for Python
(and R), also provide the software needed to host the apps online. There are two options
they provide:

- Shiny server (open source): This is a server that can host Shiny apps and is
  recommended for small deployments. It can be installed on a local server or on a cloud
  service like AWS, Google Cloud, etc.
- Posit Connect (paid): This is a cloud service that can host Shiny apps and is
  recommended for larger deployments. It is a paid service and likely requires
  institutional support.

Details on how to install and configure either option can be found on the
[Shiny server website](https://posit.co/products/open-source/shinyserver/)

## Deploying the apps to the server

The Git repository file structure is setup to build and test the apps locally. In order
to deploy the apps to a server, separate folders for each app (SCUIRREL and ACCORNS)
should be generated using the following steps:

### 1. Run the [generate_publishing_dir.py](../publish/generate_publishing_dir.py) script

You can set the first argument to `ACCORNS` or `SCUIRREL` to generate the respective
deployment folder

```bash
python generate_publishing_dir.py ACCORNS
python generate_publishing_dir.py SCUIRREL
```

_This will generate or overwrite the SCUIRREL / ACCORNS folder in the publish directory_

### 2. Check the shared_config.toml file in publishing folder

- remoteAppDB should be set to True to ensure PostgreSQL is used
- The postgres host / port should be set to match your PostgreSQL server
- Other settings in the shared_config.toml, accorns_config.toml and scuirrel_config.toml
  files should be set to match your preferred setup (details in the
  [developer guide](developer.md))

### 3. (OPTION 1) Publish the app to Posit Connect

You will need
- The URL of a Posit Connect server
- An API key for the Posit Connect server with publish access

Navigate to the publish/SCUIRREL or publish/ACCORNS folder and run the following command
to upload the app to the specified server, install all necessary dependencies and deploy
it:

```bash
rsconnect deploy shiny \
  --server <server URL> \
  --api-key <API key> \
  --environment <POSTGRES_PASS_SCUIRREL> \
  --environment <POSTGRES_PASS_ACCORNS> \
  --environment <OPENAI_API_KEY> \
  --environment <OPENAI_ORGANIZATION> \
  ./
```

_Replace the <...> with all your keys you have setup as environment variables (e.g.
%POSTGRES_PASS_SCUIRREL% on Windows or $POSTGRES_PASS_SCUIRREL on Linux/MacOS). See part
4 for more details on how to set these variables if you don't have them at the time of
first deployment_

If you already deployed the app before, you can update it with the same command but can
let out the environment variables (they only need to be set once). It's recommended to
add the GUID of the app to the command to ensure the correct app is updated
`--app-id <GUID>`. You can find these IDs in the Posit Connect dashboard.

For more info visit https://docs.posit.co/connect/admin/

### 3. (OPTION 2) Deploy the app to a Shiny server.

This is done manually by copying the contents of the SCUIRREL or ACCORNS folder to the
correct location on the server. The server should be configured to run Python Shiny apps
and have the necessary dependencies installed.

For more info visit https://rstudio.github.io/shiny-server/os/latest/

### 4. Setup the necessary remote environment variables

The following environment variables need to be accessible by _both_ apps on the server:

- POSTGRES_PASS_SCUIRREL : The password for the scuirrel user
- POSTGRES_PASS_ACCORNS : The password for the accorns user
- OPENAI_API_KEY : The key for accessing the OpenAI API
- OPENAI_ORGANIZATION : The organization ID for accessing the OpenAI API (is this needed
  in case your default organization does not match the one used by the API key)

NOTE: On Posit Connect you can also add environment variables _after_ the apps are
deployed if you don't have all the necessary keys yet. Anyone with edit access can add
them in the online app's settings page. NOTE: If they were not set when deployed with
`rsconnect` the first deployment of the apps will fail as the environment variables are
not set yet.

## Monitoring the apps

By accessing the accorns database, you can monitor the usage of the SCUIRREL and ACCORNS
apps. The most useful table for this purpose is 'sessions' table, which logs whenever
someone starts / ends a session. The error column will also record any session that
ended because of an app crash, with a traceback of the error for debugging purposes
(though these should also be logged by PositConnect / Shiny Server).
